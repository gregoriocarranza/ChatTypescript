<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Socket.IO Chat</title>
    <script type="module">
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';
        const socket = io('http://localhost:3030');

        document.addEventListener('DOMContentLoaded', () => {

            socket.on('NEW_MESSAGE', function (msg) {
                const item = document.createElement('li');
                item.textContent = msg;
                document.getElementById('messages').appendChild(item);
                window.scrollTo(0, document.body.scrollHeight);
            });


            socket.on('NEW_USER', function (users) {
                const existingUsers = Array.from(roomSelect.options).map(option => option.value);

                const defaultOption = roomSelect.children[0];

                users.forEach(user => {
                    if (!existingUsers.includes(user.key)) {
                        const option = document.createElement('option');
                        option.value = user.key;
                        option.textContent = user.name;
                        roomSelect.appendChild(option);
                    }
                });
            });



            const form = document.getElementById('form');
            const input = document.getElementById('input');
            const roomSelect = document.getElementById('roomSelect');

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const message = input.value;
                const room = roomSelect.value;

                fetch('http://localhost:3030/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: "gregoriocarranza@gmail.com",
                        room: room,
                        message: message
                    })
                }).then(response => response.json())
                    .then(data => console.log(data))
                    .catch(error => console.error('Error:', error));

                input.value = '';

            });
        });
    </script>

</head>

<body>
    <ul id="messages"></ul>
    <form id="form" action="">
        <select id="roomSelect">
            <option value="general">General</option>
        </select>
        <input id="input" autocomplete="off"><button>Send</button>
    </form>
</body>
<script>

</script>

</html>